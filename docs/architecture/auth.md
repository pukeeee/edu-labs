# Система Автентифікації "Dev Knowledge Base"

Цей документ описує архітектуру та принципи роботи системи автентифікації в проєкті.

## 1. Загальний огляд (High-Level Overview)

Система автентифікації побудована на базі **Supabase Auth** з використанням **OAuth** провайдера (Google). Вона розроблена для роботи в середовищі Next.js (App Router) і забезпечує безпечний, надійний та безшовний досвід для користувача.

**Ключові технології:**

-   **Фреймворк:** Next.js 14+ (App Router)
-   **Сервіс автентифікації:** Supabase
-   **Провайдери:** Google (OAuth)
-   **Керування сесією:** Supabase SSR Library (`@supabase/ssr`)
-   **Керування станом на клієнті:** Zustand

**Основні принципи:**

-   **Безпека перш за все:** Реалізовано захист від поширених вразливостей (Open Redirect, XSS).
-   **Server-Side-First:** Більшість операцій, пов'язаних з сесією, виконуються на сервері.
-   **Безшовний UX:** Користувач повертається на ту саму сторінку після входу.
-   **Синхронізація стану:** Стан сесії автоматично синхронізується між вкладками браузера.
-   **Надійність:** Система стійка до мережевих помилок завдяки retry-логіці.

---

## 2. Потік автентифікації (Authentication Flow)

Процес входу користувача складається з наступних кроків:

1.  **Ініціація (Клієнт):**
    -   Користувач натискає кнопку "Увійти через Google" (`features/auth/ui/AuthButton.tsx`).
    -   Компонент викликає `supabase.auth.signInWithOAuth()`.
    -   В параметрі `redirectTo` передається URL серверного обробника (`/auth/callback`) та поточний шлях сторінки (`next=/courses/react`), на який потрібно повернути користувача.
    -   Браузер перенаправляє користувача на сторінку згоди Google.

2.  **Підтвердження (Google & Supabase):**
    -   Користувач надає згоду в своєму Google акаунті.
    -   Google перенаправляє користувача на спеціальний URL Supabase.
    -   Supabase створює запис про користувача (якщо його немає) і генерує тимчасовий `authorization code`.

3.  **Обмін коду на сесію (Сервер):**
    -   Supabase перенаправляє користувача на наш серверний обробник: `app/auth/callback/route.ts`. В URL міститься `code` та оригінальний параметр `next`.
    -   Серверний обробник отримує `code`.
    -   Він викликає `supabase.auth.exchangeCodeForSession(code)`, обмінюючи код на повноцінну сесію (access token та refresh token).
    -   Supabase автоматично зберігає токени в безпечних `httpOnly` cookies.

4.  **Фінальний редірект (Сервер):**
    -   Серверний обробник валідує шлях, що міститься в параметрі `next`, щоб переконатись, що він є безпечним внутрішнім посиланням (захист від Open Redirect).
    -   Користувач перенаправляється на сторінку, з якої він почав процес входу (наприклад, `/courses/react`).

![Authentication Flow Diagram](httpsA://i.imgur.com/example.png "Діаграму можна додати пізніше для візуалізації")

---

## 3. Опис ключових компонентів та модулів

### 3.1. `shared/lib/supabase/`

-   **`client.ts`**:
    -   **Призначення:** Створює Supabase клієнт для **клієнтського** середовища (браузера).
    -   **Архітектура:** Використовує паттерн **синглтон**. Клієнт створюється один раз і перевикористовується, що запобігає множинним з'єднанням та витокам пам'яті.
    -   **Безпека:** Використовує публічні змінні оточення (`NEXT_PUBLIC_*`).

-   **`server.ts`**:
    -   **Призначення:** Створює Supabase клієнт для **серверного** середовища (Server Components, Route Handlers, Server Actions).
    -   **Архітектура:** **Не використовує синглтон.** Новий клієнт створюється для кожного запиту, щоб забезпечити ізоляцію `cookies` між різними користувачами.
    -   **Як працює:** Автоматично зчитує та записує `cookies` з/в HTTP-запит/відповідь, що забезпечує SSR.

### 3.2. `features/auth/`

-   **`ui/AuthButton.tsx`**:
    -   Клієнтський компонент, що є точкою входу в процес автентифікації.
    -   Формує правильний `redirectTo` з поточним шляхом.
    -   Має стани завантаження та помилки для кращого UX.

### 3.3. `app/auth/callback/route.ts`

-   Серверний `Route Handler`, що є ключовим елементом безпеки.
-   Обмінює `code` на сесію.
-   Виконує безпечну валідацію `next` параметра перед редіректом.
-   Обробляє можливі помилки від OAuth провайдера або Supabase.

### 3.4. `app/providers/auth-provider.tsx`

-   Клієнтський компонент-провайдер, який огортає весь додаток.
-   **Відповідальність:**
    -   Ініціалізація сесії при першому завантаженні.
    -   Підписка на зміни стану автентифікації (`onAuthStateChange`). Це дозволяє синхронізувати стан, якщо користувач увійшов/вийшов в іншій вкладці.
    -   Перевірка сесії при поверненні фокусу на вкладку (`visibilitychange`).

### 3.5. `entities/session/model/session.store.ts`

-   Глобальний стор на базі **Zustand** для зберігання стану сесії на клієнті.
-   **Стан (`SessionState`):**
    -   `session`: Об'єкт сесії від Supabase.
    -   `user`: Об'єкт користувача.
    -   `isLoading`: Показує, чи йде процес завантаження сесії.
    -   `error`: Зберігає помилку, якщо вона виникла.
-   **Дії (`actions`):**
    -   `checkSession()`: Асинхронна функція для отримання/оновлення сесії з Supabase. Має вбудовану retry-логіку.
    -   `signOut()`: Виконує вихід користувача.
    -   `clearError()`: Очищує стан помилки.

### 3.6. `app/middleware.ts`

-   **Призначення:** Next.js Middleware, що виконується перед відмальовкою сторінки на сервері.
-   **Відповідальність:**
    -   **Оновлення сесії:** Автоматично оновлює сесію користувача (refresh token) при кожному запиті до захищеного роуту. Це гарантує, що сесія не закінчиться, поки користувач активний.
    -   **Захист роутів:** Перевіряє, чи має користувач доступ до запитаного шляху.
        -   Якщо неавторизований користувач намагається зайти на захищену сторінку (напр., `/profile`), його буде перенаправлено на головну сторінку для відкриття модального вікна входу.
        -   Якщо авторизований користувач намагається зайти на сторінку для неавторизованих (якщо такі з'являться), його буде перенаправлено на головну.
    -   **Конфігурація:** Використовує `matcher` для визначення шляхів, на яких middleware буде активним, виключаючи статичні файли для оптимізації.

---

## 4. Безпека (Security Considerations)

-   **Захист від Open Redirect:** Реалізовано у `app/auth/callback/route.ts` в функції `validateRedirectPath`. Будь-який редірект на зовнішній ресурс або з використанням небезпечних протоколів (наприклад, `javascript:`) буде заблоковано. Сервер довіряє тільки відносним шляхам, що починаються з `/`.
-   **HttpOnly Cookies:** Бібліотека `@supabase/ssr` автоматично використовує `httpOnly` cookies для зберігання токенів сесії. Це означає, що вони недоступні для зчитування з JavaScript, що є надійним захистом від XSS-атак, спрямованих на крадіжку токенів.
-   **Валідація змінних оточення:** Клієнти Supabase (`client.ts` та `server.ts`) перевіряють наявність та коректність необхідних `env` змінних при старті.

---

## 5. Конфігурація та змінні оточення

Для роботи автентифікації необхідно вказати наступні змінні в файлі `.env`:

```env
# Публічний URL вашого Supabase проєкту
NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co

# Публічний (анонімний) ключ вашого Supabase проєкту
NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your-anon-key
```

Також переконайтесь, що в налаштуваннях Supabase (`Authentication -> URL Configuration`) вказано правильний `Site URL` (наприклад, `http://localhost:3000` для розробки) та `Redirect URLs` (наприклад, `http://localhost:3000/auth/callback`).
